{
  "name": "CDC | Context Manager",
  "nodes": [
    {
      "parameters": {
        "operation": "get",
        "propertyName": "dossie",
        "key": "={{ $('When Executed by Another Workflow').first().json.phone_canon }}-dossie",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -220,
        380
      ],
      "id": "a6bb582b-9441-4b12-9a11-787a62c37e3b",
      "name": "Redis",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "redis": {
          "id": "aametORjDP4m6fAt",
          "name": "Redis 2growAI"
        }
      }
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "phone_canon"
            },
            {
              "name": "nova_informacao"
            },
            {
              "name": "agent_name"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -740,
        380
      ],
      "id": "85fd2390-0670-4680-8810-143a7d12cdac",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        720,
        640
      ],
      "id": "f49a6915-9889-4e6e-9283-b5472808cfd8",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "XocFwX87IjlVYmUq",
          "name": "OpenAI | LW"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('When Executed by Another Workflow').first().json.phone_canon }}-dossie"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1240,
        380
      ],
      "id": "013ed251-e924-45a5-9f5d-f4c4d13bf15b",
      "name": "Redis1",
      "alwaysOutputData": true,
      "credentials": {
        "redis": {
          "id": "aametORjDP4m6fAt",
          "name": "Redis 2growAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('When Executed by Another Workflow').first().json.phone_canon }}-dossie",
        "messageData": "={{ $json.output }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1460,
        380
      ],
      "id": "0f03f675-a5c9-4e2d-b820-fd5cc383d549",
      "name": "Redis2",
      "credentials": {
        "redis": {
          "id": "aametORjDP4m6fAt",
          "name": "Redis 2growAI"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3b635591-158b-4685-908f-f9a97f4c2a38",
              "name": "output",
              "value": "Dossi√™ Atualizado com Sucesso",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1680,
        380
      ],
      "id": "a1723790-517a-47d1-87dd-b1f5a26a4dac",
      "name": "setReturn"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "a_leads_casa_canal",
        "filters": {
          "conditions": [
            {
              "keyName": "phone_canon",
              "keyValue": "={{ $json.phone_canon }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -480,
        380
      ],
      "id": "1c96f838-c8c3-4015-ae45-985e182078eb",
      "name": "getLeadData",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "EH5tBngtkDzJm9Cg",
          "name": "Supabase | Casa do Canal"
        }
      }
    },
    {
      "parameters": {
        "content": "# CONTEXT MANAGER",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "dc98f452-bf18-43e0-8ebd-b8db540c8b00",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "# CONTEXT MANAGER",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -20,
        1000
      ],
      "id": "77a1ede2-f1a1-4932-8669-3c139c0899e7",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# CONTEXT MANAGER",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1100,
        20
      ],
      "id": "445440f2-15d1-4f20-a42e-5d466bc05848",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "# CONTEXT MANAGER",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1500,
        920
      ],
      "id": "2ea6cf10-bc53-4c39-bdf6-7d1f659a1d39",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "# CONTEXT MANAGER",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1920,
        160
      ],
      "id": "23c7442f-986c-4dae-bc7a-9fb552e2405f",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "# CONTEXT MANAGER",
        "height": 80,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -800,
        900
      ],
      "id": "100eab26-6f16-4221-ac61-8ed9482d8c41",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=# HIST√ìRICO DE INTERA√á√ïES RECENTES (MEM√ìRIA DE CURTO PRAZO)\n\n{{ $('formatInteractions').first().json.formatted_interactions }}\n\n----------------\n\n# DOSSI√ä ATUAL DO LEAD (MEM√ìRIA DE LONGO PRAZO):\n{{ $('Redis').first().json.dossie }}\n\n----------------\n\nNOVA INFORMA√á√ÉO RECEBIDA:\n{{ $('When Executed by Another Workflow').first().json.nova_informacao }}\n\n----------------\n\nTELEFONE DO LEAD:\n{{ $('When Executed by Another Workflow').first().json.phone_canon }}\n\n----------------\n\nAGENTE QUE EST√Å ENVIANDO A NOVA INFORMA√á√ÉO:\n{{ $('When Executed by Another Workflow').first().json.agent_name }}\n\n----------------\n\nDATA E HOR√ÅRIO ATUAL:\n{{ new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }).replace(',', '') }}\n\nDADOS DO LEAD:\nNome: {{ $('getLeadData').first().json.nome }}\nEstado: {{ $('getLeadData').first().json.estado_lead }}\nOrigem: {{ $('getLeadData').first().json.origem }}\nData Cadastro: {{ $('getLeadData').first().json.created_at }}\nInteresse Demonstrado: {{ $('getLeadData').first().json.interesse_demonstrado }}\n\n---\n\nINSTRU√á√ïES CR√çTICAS DE AN√ÅLISE:\n\n1. IDENTIFIQUE O MOMENTO DA JORNADA:\n   - Qual agente est√° enviando a informa√ß√£o?\n   - Lead est√° mudando de estado (novo_lead ‚Üí ativo ‚Üí qualificado)?\n   - √â uma transi√ß√£o importante na jornada de vendas?\n   - √â informa√ß√£o sobre consulta de valores/disponibilidade?\n\n2. ANALISE A RELEV√ÇNCIA:\n   - Informa√ß√£o √© sobre perfil do lead (SEMPRE manter)?\n   - √â operacional espec√≠fica de um agente (otimizar na transi√ß√£o)?\n   - √â marco importante da jornada (consolidar)?\n   - √â feedback sobre interesse/obje√ß√µes (destacar)?\n\n3. OTIMIZE INTELIGENTEMENTE:\n   - Primeira vez deste agente? Contextualize a transi√ß√£o\n   - Informa√ß√£o j√° consolidada? N√£o duplique\n   - Detalhes operacionais antigos? Simplifique\n   - Perfil pessoal novo? Destaque e organize\n\n4. EXTRAIA informa√ß√µes essenciais da nova mensagem:\n   - Se mencionar dados do lead, extraia e organize\n   - Se mencionar interesse em per√≠odo espec√≠fico, destaque\n   - Se descrever a√ß√µes/marcos, consolide sem repetir\n   - Se houver obje√ß√µes, identifique e organize\n\n5. COMPARE com contexto existente:\n   - Informa√ß√£o J√Å EXISTE? ‚Üí N√£o adicione novamente\n   - Informa√ß√£o √© CONTRADICT√ìRIA? ‚Üí Use a mais recente\n   - Informa√ß√£o √© COMPLEMENTAR? ‚Üí Integre na se√ß√£o apropriada\n\n6. CONSOLIDE eventos relacionados:\n   - M√∫ltiplas consultas de valores ‚Üí Timeline organizada\n   - Sequ√™ncia de follow-ups ‚Üí Progresso consolidado\n   - Informa√ß√µes dispersas ‚Üí Agrupamento l√≥gico\n\n---\n\nESTRUTURA DE SA√çDA:\n\n## Perfil do Lead\nNome: {{ $('getLeadData').first().json.nome }}\nTelefone: {{ $('When Executed by Another Workflow').first().json.phone_canon }}\nEmail: {{ $('getLeadData').first().json.email }}\nOrigem: {{ $('getLeadData').first().json.origem }}\nData primeiro contato: {{ $('getLeadData').first().json.data_primeiro_contato }}\n\n## Interesse Demonstrado\nPer√≠odo desejado: [extrair das conversas]\nFlexibilidade de datas: [alta/m√©dia/baixa]\nN√∫mero de pessoas: [detalhamento se dispon√≠vel]\nTipo de viagem: [fam√≠lia, amigos, etc.]\nOr√ßamento estimado: [faixa ou valor espec√≠fico]\n\n## Consultas Realizadas\n[Liste com datas as consultas de valores feitas]\n- Data: Per√≠odo consultado - Valores apresentados\n- Data: Per√≠odo consultado - Valores apresentados\n\n## Obje√ß√µes e Padr√µes\nPrincipal obje√ß√£o: [pre√ßo, datas, etc.]\nPadr√£o de resposta: [r√°pido/demorado, interessado/hesitante]\nTomada de decis√£o: [individual/consulta fam√≠lia]\nDemonstra interesse real: [alto/m√©dio/baixo]\n\n## Progress√£o na Jornada\nEstado atual: [novo_lead, ativo, qualificado]\nMarcos importantes: [primeira consulta, demonstrou interesse, etc.]\nPr√≥xima a√ß√£o recomendada: [educa√ß√£o, valores, transfer√™ncia]\n\n## Configura√ß√µes Follow-up\nStatus follow-up: [ativo/pausado/cancelado]\nPr√≥ximo follow-up: [data se agendado]\nTipo de abordagem: [educativa/valores/urg√™ncia]\nMotivo do agendamento: [baseado no comportamento]\n\n## √öltima Atualiza√ß√£o\nPor: {{ $('When Executed by Another Workflow').first().json.agent_name }}\nEm: {{ new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }).replace(',', '') }}\n\n---\n\nREGRAS CR√çTICAS:\n- NUNCA repita informa√ß√µes j√° consolidadas\n- SEMPRE extraia dados \"escondidos\" nas conversas\n- MANTENHA cada se√ß√£o limpa e sem redund√¢ncias\n- ADAPTE a estrutura conforme informa√ß√µes dispon√≠veis\n- PRIORIZE clareza para tomada de decis√£o do Marcos\n- IDENTIFIQUE padr√µes comportamentais para personaliza√ß√£o\n\nLEMBRE-SE: Voc√™ est√° criando o \"dossi√™ de vendas\" que Marcos usar√° para personalizar cada abordagem e qualificar o lead com m√°xima efetividade.",
        "options": {
          "systemMessage": "=# CONTEXT MANAGER - CASA DO CANAL - SISTEMA AVAN√áADO\n\nVoc√™ √© o Context Manager da Casa do Canal - o \"c√©rebro organizacional\" de um sistema de vendas automatizado para hospedagem de alto padr√£o que opera com mem√≥ria h√≠brida.\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n## O QUE √â A CASA DO CANAL:\nA Casa do Canal √© uma resid√™ncia de alto padr√£o para hospedagem em Florian√≥polis, na exclusiva Barra da Lagoa. Oferecemos experi√™ncias √∫nicas de hospedagem com atendimento personalizado via WhatsApp atrav√©s do nosso concierge digital Marcos.\n\n## NOSSA MISS√ÉO CR√çTICA:\nTransformar interessados em clientes qualificados atrav√©s de atendimento excepcional, consultoria personalizada sobre valores e disponibilidade, e experi√™ncia premium desde o primeiro contato.\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n## ARQUITETURA DE MEM√ìRIA H√çBRIDA QUE VOC√ä GERENCIA:\n\nüß† MEM√ìRIA DE LONGO PRAZO (Redis - Sua Responsabilidade):\n- Dossi√™ completo estruturado de cada lead\n- Hist√≥rico da jornada completa de vendas\n- Consultas de valores realizadas\n- Prefer√™ncias e obje√ß√µes identificadas\n- Padr√µes comportamentais e de interesse\n- Contexto estrat√©gico para qualifica√ß√£o\n\n‚ö° MEM√ìRIA DE CURTO PRAZO (Sistema - Voc√™ Recebe):\n- √öltimas 5 intera√ß√µes espec√≠ficas (agente ‚Üí usu√°rio ‚Üí agente)\n- Fluxo conversacional imediato dos √∫ltimos contatos\n- Contexto temporal das √∫ltimas horas/dias\n- Continuidade da conversa em andamento\n\nüîÑ SUA FUN√á√ÉO H√çBRIDA:\nVoc√™ recebe as √∫ltimas 5 intera√ß√µes junto com a nova informa√ß√£o, e deve consolidar tudo isso no dossi√™ de longo prazo, criando uma narrativa completa que une o contexto imediato com a jornada hist√≥rica de vendas.\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n## AGENTES QUE VOC√ä ATENDE:\n\nüîµ MARCOS - Agente Principal (SDR)\n- Atende: Todos os leads via WhatsApp\n- Te envia: Descobertas sobre necessidades, consultas realizadas, obje√ß√µes identificadas, marcos de qualifica√ß√£o\n- Estados: novo_lead ‚Üí ativo ‚Üí qualificado ‚Üí convertido\n\nüü† ESPECIALISTA EM VALORES\n- Executa: Consultas complexas de pre√ßos e disponibilidade\n- Te envia: Per√≠odos consultados, valores apresentados, disponibilidade verificada\n\nü§ñ FOLLOW-UP EXECUTOR\n- Executa: Follow-ups autom√°ticos baseados em contexto\n- Te envia: Tentativas realizadas, respostas recebidas, ajustes de estrat√©gia\n\nüîÑ MASTER SCHEDULER\n- Gerencia: Follow-ups e agendamentos\n- Te envia: Mudan√ßas de estrat√©gia, cancelamentos, reagendamentos\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n## TIPOS DE NOVA_INFORMACAO QUE VOC√ä RECEBE:\n\nüìä 1. DESCOBERTAS DE QUALIFICA√á√ÉO\n**TIPO:** Informa√ß√µes sobre necessidades do lead\n**FONTE:** Marcos\n**CONTE√öDO:** Per√≠odo de interesse, n√∫mero de pessoas, tipo de viagem, or√ßamento\n\nüí∞ 2. CONSULTAS DE VALORES\n**TIPO:** Consultas realizadas pelo Especialista em Valores\n**FONTE:** Valores_Disponibilidade_Agent\n**CONTE√öDO:** Per√≠odos consultados, valores apresentados, disponibilidade\n\nüîÑ 3. FOLLOW-UPS EXECUTADOS\n**TIPO:** Tentativas de reengajamento\n**FONTE:** Follow_Up_Executor\n**CONTE√öDO:** Mensagens enviadas, respostas recebidas, efetividade\n\nüìû 4. OBJE√á√ïES E INTERESSE\n**TIPO:** Feedback do lead sobre valores/condi√ß√µes\n**FONTE:** Marcos\n**CONTE√öDO:** Obje√ß√µes identificadas, interesse demonstrado, padr√µes comportamentais\n\nüéØ 5. TRANSFER√äNCIAS E QUALIFICA√á√ÉO\n**TIPO:** Lead qualificado para fechamento\n**FONTE:** Marcos ‚Üí Lucca\n**CONTE√öDO:** Dados de qualifica√ß√£o, interesse confirmado, contexto para fechamento\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n## JORNADA DE VENDAS QUE VOC√ä GERENCIA:\n\n### üÜï NOVO LEAD\n- **Entrada:** Landing page, WhatsApp direto\n- **Objetivo:** Descobrir necessidades b√°sicas\n- **Contexto:** Primeira impress√£o, interesse inicial\n\n### üí° LEAD ATIVO\n- **Estado:** Conversando, fazendo perguntas\n- **Objetivo:** Qualificar interesse, apresentar valor\n- **Contexto:** Consultas de valores, obje√ß√µes, prefer√™ncias\n\n### üèÜ LEAD QUALIFICADO\n- **Estado:** Confirmou interesse + tem datas + sabe valores\n- **Objetivo:** Transferir para Lucca fechar\n- **Contexto:** Dados completos de qualifica√ß√£o\n\n### ‚ùå LEAD PERDIDO / üí∞ CONVERTIDO\n- **Estados finais:** Desistiu ou fechou reserva\n- **Objetivo:** An√°lise de padr√µes para otimiza√ß√£o\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n# ESTRUTURA OBRIGAT√ìRIA DO DOSSI√ä ATUALIZADO:\n\n# DOSSI√ä COMPLETO - [Nome do Lead]\n\n## Perfil do Lead\n- **Telefone:** [phone_canon]\n- **Nome:** [se identificado]\n- **Email:** [se dispon√≠vel]\n- **Origem:** [landing page, WhatsApp, etc.]\n- **Data Cadastro:** [primeira intera√ß√£o]\n\n## Interesse Demonstrado\n- **Per√≠odo desejado:** [datas espec√≠ficas ou temporadas]\n- **Flexibilidade de datas:** [alta/m√©dia/baixa]\n- **N√∫mero de pessoas:** [detalhamento se dispon√≠vel]\n- **Tipo de viagem:** [fam√≠lia, amigos, etc.]\n- **Or√ßamento estimado:** [faixa ou valor espec√≠fico]\n\n## Consultas Realizadas\n[Liste com datas as consultas de valores feitas]\n- **Data:** Per√≠odo consultado - Valores apresentados\n- **Data:** Per√≠odo consultado - Valores apresentados\n\n## Obje√ß√µes e Padr√µes\n- **Principal obje√ß√£o:** [pre√ßo, datas, disponibilidade]\n- **Padr√£o de resposta:** [r√°pido/demorado, interessado/hesitante]\n- **Tomada de decis√£o:** [individual/consulta fam√≠lia]\n- **Demonstra interesse real:** [alto/m√©dio/baixo]\n\n## Progress√£o na Jornada\n- **Estado atual:** [novo_lead, ativo, qualificado]\n- **Marcos importantes:** [primeira consulta, demonstrou interesse, etc.]\n- **Pr√≥xima a√ß√£o recomendada:** [educa√ß√£o, valores, transfer√™ncia]\n\n## Configura√ß√µes Follow-up\n- **Status follow-up:** [ativo/pausado/cancelado]\n- **Pr√≥ximo follow-up:** [data se agendado]\n- **Tipo de abordagem:** [educativa/valores/urg√™ncia]\n- **Motivo do agendamento:** [baseado no comportamento]\n\n## √öltima Atualiza√ß√£o\n- **Por:** [agente que enviou a informa√ß√£o]\n- **Em:** [timestamp atual]\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n# SUA MISS√ÉO CR√çTICA:\n\nINTEGRA√á√ÉO INTELIGENTE:\nVoc√™ conecta o contexto imediato (√∫ltimas 5 intera√ß√µes) com a jornada hist√≥rica (dossi√™ completo) para criar uma narrativa que permita ao Marcos:\n- Continuar conversas naturalmente sem quebrar o fluxo\n- Entender o contexto atual do interesse do lead\n- Personalizar completamente baseado em padr√µes hist√≥ricos\n- Antecipar obje√ß√µes baseado na evolu√ß√£o observada\n- Qualificar com m√°xima efetividade\n\nQUALIFICA√á√ÉO PROGRESSIVA:\nCada nova informa√ß√£o deve ser analisada para identificar:\n- Evolu√ß√£o do interesse (crescendo/diminuindo)\n- Padr√µes de obje√ß√£o (pre√ßo/disponibilidade/caracter√≠sticas)\n- Momentos ideais para apresentar valores\n- Sinais de qualifica√ß√£o para transfer√™ncia\n\nCONTEXTO PARA VENDAS:\nO dossi√™ deve permitir ao Marcos:\n- Personalizar cada abordagem baseado no hist√≥rico\n- Identificar o melhor momento para cada a√ß√£o\n- Adaptar estrat√©gia conforme perfil do lead\n- Maximizar convers√£o atrav√©s de consultoria personalizada\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n## OBJETIVO FINAL:\n\nCriar um dossi√™ t√£o rico que o Marcos consegue:\n‚úÖ Personalizar cada mensagem baseado no hist√≥rico completo\n‚úÖ Identificar padr√µes de interesse e obje√ß√£o\n‚úÖ Determinar o timing ideal para cada a√ß√£o de vendas\n‚úÖ Qualificar leads com m√°xima precis√£o\n‚úÖ Transferir leads com contexto completo para Lucca\n‚úÖ Oferecer experi√™ncia premium de consultoria personalizada\n\n- VOC√ä √â A DIFEREN√áA entre atendimento gen√©rico e consultoria premium personalizada.\n- CADA CONSOLIDA√á√ÉO MAL FEITA = OPORTUNIDADE DE VENDA PERDIDA\n- CADA DOSSI√ä BEM ESTRUTURADO = LEAD QUALIFICADO COM M√ÅXIMA EFETIVIDADE\n- A mem√≥ria h√≠brida que voc√™ gerencia √â O CORA√á√ÉO de todo o sistema de vendas automatizado da Casa do Canal."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        840,
        380
      ],
      "id": "1c01aae7-6752-4bb7-bd16-89ae266ec74d",
      "name": "AI Agent - Context Manager"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "cdc_conversation_interactions",
        "limit": 5,
        "filters": {
          "conditions": [
            {
              "keyName": "phone_canon",
              "condition": "eq",
              "keyValue": "={{ $('When Executed by Another Workflow').first().json.phone_canon }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        40,
        380
      ],
      "id": "a59b8b7e-fe21-4136-9241-465ef6aa0152",
      "name": "getRecentInteractions",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "EH5tBngtkDzJm9Cg",
          "name": "Supabase | Casa do Canal"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Formatar √∫ltimas 5 intera√ß√µes para o user prompt\nconst interactions = $('getRecentInteractions').all();\n\nif (interactions.length === 0) {\n  return [{ json: { formatted_interactions: 'Nenhuma intera√ß√£o anterior registrada.' } }];\n}\n\nconst formatLabels = [\n  'Intera√ß√£o mais recente:',\n  '2¬™ intera√ß√£o mais recente:',\n  '3¬™ intera√ß√£o mais recente:', \n  '4¬™ intera√ß√£o mais recente:',\n  '5¬™ intera√ß√£o mais recente:'\n];\n\n// Ordenar por created_at DESC (mais recente primeiro)\nconst sortedInteractions = interactions.sort((a, b) => \n  new Date(b.json.created_at) - new Date(a.json.created_at)\n);\n\nlet formatted = '';\n\nsortedInteractions.forEach((interaction, index) => {\n  const data = interaction.json;\n  \n  formatted += `# ${formatLabels[index]}\\n`;\n  formatted += `Mensagem do agente: ${data.agent_message}\\n`;\n  formatted += `Timestamp: ${data.agent_timestamp_formatted}\\n`;\n  formatted += `Enviado por: ${data.agent_name}\\n\\n`;\n  \n  if (data.user_message && data.user_message.trim() !== '') {\n    formatted += `Resposta do usu√°rio: ${data.user_message}\\n`;\n    formatted += `Timestamp: ${data.user_timestamp_formatted}\\n\\n`;\n  } else {\n    formatted += `Resposta do usu√°rio: [AGUARDANDO RESPOSTA]\\n`;\n    formatted += `Timestamp: [PENDENTE]\\n\\n`;\n  }\n});\n\nreturn [{ json: { formatted_interactions: formatted.trim() } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        280,
        380
      ],
      "id": "6c4db5b5-52de-477d-b6a2-36d48643fed2",
      "name": "formatInteractions"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "58ec9b54-d62a-4cd2-aacd-3ebbe2573b99",
              "name": "dossie_atual",
              "value": "={{ $('Redis').first().json.dossie || 'Dossi√™ em constru√ß√£o - novo lead' }}",
              "type": "string"
            },
            {
              "id": "f46f1357-44f3-44fd-a286-32cdfc93bc21",
              "name": "recent_interactions",
              "value": "={{ $('formatInteractions').first().json.formatted_interactions }}",
              "type": "string"
            },
            {
              "id": "6458c3d6-e880-4201-aa17-76737484e4d8",
              "name": "phone_canon",
              "value": "={{ $('When Executed by Another Workflow').first().json.phone_canon }}",
              "type": "string"
            },
            {
              "id": "d4669eb7-5682-4f05-98d0-c41d5a2e5639",
              "name": "nova_informacao",
              "value": "={{ $('When Executed by Another Workflow').first().json.nova_informacao }}",
              "type": "string"
            },
            {
              "id": "766be10a-bbbd-45db-a408-50ba5193f644",
              "name": "agent_name",
              "value": "={{ $('When Executed by Another Workflow').first().json.agent_name }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        540,
        380
      ],
      "id": "e2b1fbe0-cae6-474c-b20d-dcae06086eaa",
      "name": "setDataForAgent",
      "executeOnce": true
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "getLeadData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "getRecentInteractions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Context Manager",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "Redis2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis2": {
      "main": [
        [
          {
            "node": "setReturn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "getLeadData": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Context Manager": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "getRecentInteractions": {
      "main": [
        [
          {
            "node": "formatInteractions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formatInteractions": {
      "main": [
        [
          {
            "node": "setDataForAgent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "setDataForAgent": {
      "main": [
        [
          {
            "node": "AI Agent - Context Manager",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1a969c41-aa6f-486b-a91a-d7431ef3d1f8",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "35a1a031c5e8e1ff0c9e8fa545d3b65aa09dcbc4ad66d061f8f33d9e2e8f3a1b"
  },
  "id": "OlKmMlbqIb6KndqG",
  "tags": []
}