{
  "name": "CDC | Valores e Disponibilidade Agent",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bc37b42f-cf4a-48b4-be29-38c0d01e8ed1",
              "name": "consulta_original",
              "value": "={{ $json.consulta_cliente }}",
              "type": "string"
            },
            {
              "id": "e96943ed-56de-456d-bfdc-6553a81b99d6",
              "name": "phone_canon",
              "value": "={{ $json.phone_canon }}",
              "type": "string"
            },
            {
              "id": "ff2724bb-7bb1-425d-819f-22d1e9c706af",
              "name": "timestamp_consulta",
              "value": "={{ $now }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -280,
        -180
      ],
      "id": "768a00a5-7136-4846-98e0-6df5ccbbc1b8",
      "name": "setConsultaData"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "responseFormat": "text",
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -100,
        60
      ],
      "id": "30a2a2b5-7abd-442b-9b58-068856856716",
      "name": "OpenAI Chat Model - Query Generator",
      "credentials": {
        "openAiApi": {
          "id": "XocFwX87IjlVYmUq",
          "name": "OpenAI | LW"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© o especialista em traduzir consultas de hospedagem em filtros SQL precisos para a Casa do Canal.\n\n# CONSULTA RECEBIDA:\n{{ $json.consulta_original }}\n\n# SUA MISS√ÉO:\nTraduzir esta consulta em filtros SQL espec√≠ficos para a tabela b_periodos_casa_canal.\n\n# TIPOS DE CONSULTA POSS√çVEIS:\n1. **Temporada**: \"alta temporada\", \"baixa temporada\" ‚Üí tipo_periodo\n2. **M√™s espec√≠fico**: \"janeiro\", \"outubro\" ‚Üí data_inicio/data_fim\n3. **Feriado**: \"carnaval\", \"natal\", \"reveillon\" ‚Üí nome_periodo ILIKE\n4. **Per√≠odo espec√≠fico**: \"10 a 12 de outubro\" ‚Üí datas exatas\n5. **Consulta geral**: \"valores gerais\", \"tudo\" ‚Üí sem filtros espec√≠ficos\n\n# ESTRUTURA DA TABELA:\n- data_inicio (DATE)\n- data_fim (DATE) \n- ano (INTEGER)\n- tipo_periodo (TEXT): 'alta_temporada', 'baixa_temporada', 'feriado'\n- nome_periodo (TEXT): 'Carnaval 2026', 'Natal 2025', etc.\n- disponivel (BOOLEAN)\n- prioridade (INTEGER): 1=feriado, 2=alta_temporada, 3=baixa_temporada\n\n# FORMATO DE RESPOSTA (JSON):\n```json\n{\n  \"tipo_consulta\": \"alta_temporada|baixa_temporada|mes_especifico|feriado|periodo_especifico|geral\",\n  \"filtros\": {\n    \"tipo_periodo\": \"alta_temporada\",\n    \"ano\": 2025,\n    \"data_inicio_lte\": \"2025-10-31\",\n    \"data_fim_gte\": \"2025-10-01\",\n    \"nome_periodo_ilike\": \"%carnaval%\"\n  },\n  \"observacoes\": \"Per√≠odo espec√≠fico ou considera√ß√µes especiais\"\n}\n```\n\n# REGRAS IMPORTANTES:\n- Ano padr√£o: 2025 (se n√£o especificado)\n- Para meses: usar data_inicio_lte e data_fim_gte para capturar sobreposi√ß√µes\n- Para feriados: usar nome_periodo ILIKE\n- Para temporadas: usar tipo_periodo exato\n\nRESPONDA APENAS O JSON:",
        "options": {
          "systemMessage": "=Voc√™ √© um especialista em SQL e an√°lise de dados de hospedagem. Seja preciso e objetivo.\n\n# REGRA CR√çTICA SOBRE ANOS:\n- Para consultas de TEMPORADA (\"alta temporada\", \"baixa temporada\"): SEMPRE buscar 2025 E 2026\n- Para consultas espec√≠ficas de m√™s/feriado: usar ano atual/pr√≥ximo conforme contexto  \n- Para consultas gerais: buscar ambos os anos (2025 e 2026)\n\nEsta regra √© fundamental porque os dados de temporada est√£o distribu√≠dos entre os dois anos.\n\n\n\n# Exemplos de input e output\n\n## Exemplo 1:\nInput: \"H√≥spede quer saber valor para alta temporada\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"alta_temporada\",\n  \"filtros\": {\n    \"tipo_periodo\": \"alta_temporada\",\n    \"ano\": 2025\n  },\n  \"observacoes\": \"Consulta para todos os per√≠odos de alta temporada\"\n}\n\n\n\n## Exemplo 2:\nInput: \"H√≥spede quer saber valor para outubro\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"mes_especifico\",\n  \"filtros\": {\n    \"ano\": 2025,\n    \"data_inicio_lte\": \"2025-10-31\",\n    \"data_fim_gte\": \"2025-10-01\"\n  },\n  \"observacoes\": \"M√™s espec√≠fico - outubro 2025\"\n}\n\n\n\n## Exemplo 3:\nInput: \"H√≥spede quer saber valor para carnaval\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"feriado\",\n  \"filtros\": {\n    \"nome_periodo_ilike\": \"%carnaval%\",\n    \"ano\": 2025\n  },\n  \"observacoes\": \"Feriado espec√≠fico - Carnaval\"\n}\n\n\n\n## Exemplo 4:\nInput: \"H√≥spede quer saber valor do dia 10 ao dia 13 de outubro\"\nOutput:\njson{\n  \"tipo_consulta\": \"periodo_especifico\",\n  \"filtros\": {\n    \"ano\": 2025,\n    \"data_inicio_lte\": \"2025-10-13\",\n    \"data_fim_gte\": \"2025-10-10\"\n  },\n  \"observacoes\": \"Per√≠odo espec√≠fico de 4 dias em outubro\"\n}\n\n\n\n## Exemplo 5:\nInput: \"H√≥spede quer saber valor para baixa temporada\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"baixa_temporada\",\n  \"filtros\": {\n    \"tipo_periodo\": \"baixa_temporada\",\n    \"ano\": 2025\n  },\n  \"observacoes\": \"Todos os per√≠odos de baixa temporada\"\n}\n\n\n\n## Exemplo 6:\nInput: \"H√≥spede quer saber valor para dezembro\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"mes_especifico\",\n  \"filtros\": {\n    \"ano\": 2025,\n    \"data_inicio_lte\": \"2025-12-31\",\n    \"data_fim_gte\": \"2025-12-01\"\n  },\n  \"observacoes\": \"M√™s espec√≠fico - dezembro 2025\"\n}\n\n\n\n\n## Exemplo 7:\nInput: \"H√≥spede quer saber valores gerais da casa\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"geral\",\n  \"filtros\": {\n    \"ano\": 2025\n  },\n  \"observacoes\": \"Consulta geral de todos os valores dispon√≠veis\"\n}\n\n\n\n## Exemplo 8:\nInput: \"H√≥spede quer saber valor para reveillon\"\n\nOutput:\njson{\n  \"tipo_consulta\": \"feriado\",\n  \"filtros\": {\n    \"nome_periodo_ilike\": \"%r√©veillon%\",\n    \"ano\": 2025\n  },\n  \"observacoes\": \"Feriado espec√≠fico - R√©veillon/Ano Novo\"\n}\n\n",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -60,
        -180
      ],
      "id": "d48b1496-d8db-4863-ab75-993be3b8be7d",
      "name": "AI Agent - Query Generator"
    },
    {
      "parameters": {
        "jsCode": "// Parse da resposta do LLM Query Generator\nconst llmResponse = $('AI Agent - Query Generator').item.json.output;\nconst consultaOriginal = $('setConsultaData').item.json.consulta_original;\n\ntry {\n  // Extrair JSON da resposta\n  const jsonMatch = llmResponse.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                   llmResponse.match(/\\{[\\s\\S]*\\}/);\n  \n  if (!jsonMatch) {\n    throw new Error(\"JSON n√£o encontrado na resposta\");\n  }\n  \n  const queryData = JSON.parse(jsonMatch[1] || jsonMatch[0]);\n  \n  // Construir filtros para Supabase\n  let supabaseFilters = [];\n  \n  if (queryData.filtros.tipo_periodo) {\n    supabaseFilters.push({\n      keyName: \"tipo_periodo\",\n      condition: \"eq\",\n      keyValue: queryData.filtros.tipo_periodo\n    });\n  }\n  \n  if (queryData.filtros.ano) {\n    supabaseFilters.push({\n      keyName: \"ano\",\n      condition: \"eq\", \n      keyValue: queryData.filtros.ano.toString()\n    });\n  }\n  \n  if (queryData.filtros.data_inicio_lte) {\n    supabaseFilters.push({\n      keyName: \"data_inicio\",\n      condition: \"lte\",\n      keyValue: queryData.filtros.data_inicio_lte\n    });\n  }\n  \n  if (queryData.filtros.data_fim_gte) {\n    supabaseFilters.push({\n      keyName: \"data_fim\",\n      condition: \"gte\",\n      keyValue: queryData.filtros.data_fim_gte\n    });\n  }\n  \n  if (queryData.filtros.nome_periodo_ilike) {\n    supabaseFilters.push({\n      keyName: \"nome_periodo\",\n      condition: \"ilike\",\n      keyValue: queryData.filtros.nome_periodo_ilike\n    });\n  }\n  \n  return [{\n    json: {\n      tipo_consulta: queryData.tipo_consulta,\n      supabase_filters: supabaseFilters,\n      consulta_original: consultaOriginal,\n      query_data: queryData,\n      parse_sucesso: true\n    }\n  }];\n  \n} catch (error) {\n  console.log(\"Erro no parse:\", error.message);\n  \n  // Fallback: filtros b√°sicos baseados em palavras-chave\n  const consulta = consultaOriginal.toLowerCase();\n  let fallbackFilters = [{\n    keyName: \"ano\",\n    condition: \"eq\",\n    keyValue: \"2025\"\n  }];\n  \n  if (consulta.includes(\"alta\")) {\n    fallbackFilters.push({\n      keyName: \"tipo_periodo\",\n      condition: \"eq\",\n      keyValue: \"alta_temporada\"\n    });\n  } else if (consulta.includes(\"baixa\")) {\n    fallbackFilters.push({\n      keyName: \"tipo_periodo\",\n      condition: \"eq\", \n      keyValue: \"baixa_temporada\"\n    });\n  }\n  \n  return [{\n    json: {\n      tipo_consulta: \"geral\",\n      supabase_filters: fallbackFilters,\n      consulta_original: consultaOriginal,\n      parse_sucesso: false,\n      erro: error.message\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        420,
        -180
      ],
      "id": "cf7fb0e0-26ed-4da0-9b92-969875eec4de",
      "name": "parseQueryFilters"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c77d829e-6d28-4eb9-af5b-a59fae3aa45c",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1080,
        -180
      ],
      "id": "8424aceb-5001-44b3-bbe0-0f7cd0e90ced",
      "name": "verificaResultados"
    },
    {
      "parameters": {
        "jsCode": "// Dados v√™m direto do HTTP Request agora\nconst periodos = $input.all(); // Array de per√≠odos da API Supabase\nconst queryContext = $('buildSupabaseQuery').item.json;\n\nif (periodos.length === 0) {\n  return [{\n    json: {\n      sem_resultados: true,\n      consulta_original: queryContext.consulta_original\n    }\n  }];\n}\n\n// Processar os per√≠odos (cada item j√° √© um per√≠odo do Supabase)\nconst periodosDisponiveis = periodos.filter(p => p.json.disponivel === true);\nconst periodosIndisponiveis = periodos.filter(p => p.json.disponivel === false);\n\n// Calcular estat√≠sticas\nconst valores = periodosDisponiveis.map(p => p.json.valor_noite);\nconst valorMin = Math.min(...valores);\nconst valorMax = Math.max(...valores);\n\nconst minimos = periodosDisponiveis.map(p => p.json.minimo_noites);\nconst minimoMin = Math.min(...minimos);\nconst minimoMax = Math.max(...minimos);\n\n// Agrupar por tipo_periodo\nconst grupos = {};\nperiodosDisponiveis.forEach(item => {\n  const periodo = item.json;\n  const tipo = periodo.tipo_periodo;\n  \n  if (!grupos[tipo]) {\n    grupos[tipo] = {\n      tipo_periodo: tipo,\n      periodos: [],\n      valor_min: Infinity,\n      valor_max: 0,\n      minimo_noites_min: Infinity,\n      minimo_noites_max: 0\n    };\n  }\n  \n  grupos[tipo].periodos.push(periodo);\n  grupos[tipo].valor_min = Math.min(grupos[tipo].valor_min, periodo.valor_noite);\n  grupos[tipo].valor_max = Math.max(grupos[tipo].valor_max, periodo.valor_noite);\n  grupos[tipo].minimo_noites_min = Math.min(grupos[tipo].minimo_noites_min, periodo.minimo_noites);\n  grupos[tipo].minimo_noites_max = Math.max(grupos[tipo].minimo_noites_max, periodo.minimo_noites);\n});\n\n// Formatar para an√°lise da LLM\nlet dadosFormatados = `# CONSULTA ORIGINAL\\n${queryContext.consulta_original}\\n\\n`;\ndadosFormatados += `# ESTAT√çSTICAS GERAIS\\n`;\ndadosFormatados += `- Total de per√≠odos encontrados: ${periodos.length}\\n`;\ndadosFormatados += `- Per√≠odos dispon√≠veis: ${periodosDisponiveis.length}\\n`;\ndadosFormatados += `- Per√≠odos indispon√≠veis: ${periodosIndisponiveis.length}\\n`;\n\nif (periodosDisponiveis.length > 0) {\n  dadosFormatados += `- Faixa de valores: R$${valorMin.toLocaleString('pt-BR')} - R$${valorMax.toLocaleString('pt-BR')}\\n`;\n  dadosFormatados += `- M√≠nimo de noites: ${minimoMin} - ${minimoMax}\\n\\n`;\n}\n\n// Detalhar per√≠odos dispon√≠veis\ndadosFormatados += `# PER√çODOS DISPON√çVEIS\\n`;\nperiodosDisponiveis.forEach(item => {\n  const p = item.json;\n  dadosFormatados += `## ${p.nome_periodo}\\n`;\n  dadosFormatados += `- Per√≠odo: ${p.data_inicio} a ${p.data_fim}\\n`;\n  dadosFormatados += `- Tipo: ${p.tipo_periodo}\\n`;\n  dadosFormatados += `- Valor/noite: R$${p.valor_noite.toLocaleString('pt-BR')}\\n`;\n  dadosFormatados += `- M√≠nimo noites: ${p.minimo_noites}\\n`;\n  dadosFormatados += `- Prioridade: ${p.prioridade}\\n\\n`;\n});\n\n// Listar indispon√≠veis se houver\nif (periodosIndisponiveis.length > 0) {\n  dadosFormatados += `# PER√çODOS INDISPON√çVEIS\\n`;\n  periodosIndisponiveis.forEach(item => {\n    const p = item.json;\n    dadosFormatados += `- ${p.data_inicio} a ${p.data_fim}: ${p.motivo_indisponivel}\\n`;\n  });\n}\n\nreturn [{\n  json: {\n    dados_formatados: dadosFormatados,\n    periodos_disponiveis: periodosDisponiveis.length,\n    periodos_indisponiveis: periodosIndisponiveis.length,\n    valor_min: valorMin,\n    valor_max: valorMax,\n    minimo_min: minimoMin,\n    minimo_max: minimoMax,\n    grupos_por_tipo: Object.values(grupos),\n    consulta_original: queryContext.consulta_original\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1320,
        -340
      ],
      "id": "663f0642-26b6-4326-adac-2779a284c515",
      "name": "formatDataForAnalysis"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "responseFormat": "text",
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1540,
        -160
      ],
      "id": "a841d022-e252-40ea-9e08-f234ffc973d6",
      "name": "OpenAI Chat Model - Formatador",
      "credentials": {
        "openAiApi": {
          "id": "XocFwX87IjlVYmUq",
          "name": "OpenAI | LW"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voc√™ √© o especialista t√©cnico em valores e disponibilidade da Casa do Canal.\nAnalise os dados e forne√ßa informa√ß√µes T√âCNICAS COMPLETAS para o agente Marcos processar.\n\n# DADOS PARA AN√ÅLISE:\n{{ $json.dados_formatados }}\n\n# DIRETRIZES T√âCNICAS:\n\n## ‚ö†Ô∏è M√çNIMO DE NOITES - REGRA CR√çTICA:\n- SEMPRE mencione o m√≠nimo de noites para cada per√≠odo\n- Se consulta espec√≠fica for menor que m√≠nimo, EXPLICAR limita√ß√£o t√©cnica\n- Exemplo: \"Per√≠odo solicitado: 2 noites. M√≠nimo t√©cnico: 3 noites para outubro.\"\n\n## üí∞ VALORES E FLUTUA√á√ÉO:\n- Formato: R$3.250/noite \n- Se h√° flutua√ß√£o no per√≠odo, EXPLICAR motivo t√©cnico\n- Calcular totais para per√≠odos espec√≠ficos quando aplic√°vel\n\n## üìÖ DISPONIBILIDADE:\n- Status claro: ‚úÖ Dispon√≠vel / ‚ùå Indispon√≠vel / ‚ö†Ô∏è Parcial\n- Destacar per√≠odos indispon√≠veis com motivo\n- Agrupar per√≠odos similares quando fizer sentido\n\n## üéØ AN√ÅLISE T√âCNICA:\n- Confirmar tipo de consulta processada\n- Ser espec√≠fico com datas: \"10 a 13 de outubro\" n√£o \"outubro\"\n- Fornecer resumo t√©cnico para facilitar processamento do Marcos\n\n# FORMATO DE RESPOSTA T√âCNICA:\nüìä [TIPO DE CONSULTA PROCESSADA]\nüóìÔ∏è PER√çODOS ENCONTRADOS:\n\n[Per√≠odo espec√≠fico]: R$X.XXX/noite (m√≠n. X noites) [Status]\n\n‚ö†Ô∏è RESUMO T√âCNICO:\n\nTotal per√≠odos: X dispon√≠veis, X indispon√≠veis\nFaixa valores: RX.XXX‚àíRX.XXX - R\nX.XXX‚àíRX.XXX/noite\n\nM√≠nimo noites: X a X noites\n[Observa√ß√µes t√©cnicas importantes]\n\nüí∞ AN√ÅLISE DE VALORES: [Padr√µes identificados]\n\n# CASOS T√âCNICOS ESPECIAIS:\n\n**Consulta espec√≠fica menor que m√≠nimo:**\n‚ùå LIMITA√á√ÉO T√âCNICA:\n\nPer√≠odo solicitado: X noites\nM√≠nimo obrigat√≥rio: Y noites para este per√≠odo\nStatus: N√£o atende requisitos m√≠nimos\n\n\n**Per√≠odos indispon√≠veis:**\n‚ùå INDISPONIBILIDADE:\n\nPer√≠odo: [datas]\nMotivo: [reservado/bloqueado]\n\n\n**Consulta ampla:**\nAgrupar por tipo_periodo e fornecer an√°lise estruturada.\n\nPROCESSE OS DADOS E FORNE√áA AN√ÅLISE T√âCNICA COMPLETA:\nüéØ RESULTADO ESPERADO:\n‚ùå Antes:\n\n\"üí° SUGEST√ÉO: Caso tenha interesse em feriados especiais... posso ajudar a verificar disponibilidade\n‚ùì Que per√≠odo espec√≠fico mais te interessa?\"\n\n‚úÖ Depois:\n\n\"‚ö†Ô∏è RESUMO T√âCNICO:\n\nTotal per√≠odos: 10 dispon√≠veis, 1 indispon√≠vel\nFaixa valores: R$3.800 - R$9.500/noite\nM√≠nimo noites: 4 a 7 noites\nObserva√ß√£o: R√©veillon exige 7 noites m√≠nimas\"",
        "options": {
          "systemMessage": "=Voc√™ √© o especialista t√©cnico em valores e disponibilidade da Casa do Canal.\n\n# SUA FUN√á√ÉO:\nProcessar consultas de valores/disponibilidade e fornecer dados T√âCNICOS e ESTRUTURADOS para o agente Marcos repassar ao lead.\n\n# IMPORTANTE - VOC√ä RESPONDE PARA O MARCOS, N√ÉO PARA O CLIENTE:\n- Seja T√âCNICO e INFORMATIVO\n- Forne√ßa an√°lise COMPLETA e OBJETIVA dos dados\n- N√ÉO fa√ßa perguntas ao \"cliente\" \n- N√ÉO use linguagem de atendimento direto (\"voc√™ gostaria\", \"posso ajudar\")\n- OBJETIVO: Equipar o Marcos com todas as informa√ß√µes necess√°rias\n\n# DIRETRIZES T√âCNICAS:\n\n## ‚ö†Ô∏è M√çNIMO DE NOITES:\n- SEMPRE mencione o m√≠nimo para cada per√≠odo\n- Se h√° varia√ß√£o, EXPLIQUE claramente os motivos\n\n## üí∞ VALORES:\n- Formato padr√£o: R$3.250/noite\n- Se h√° flutua√ß√£o, EXPLIQUE por qu√™\n- Calcule totais quando relevante para compara√ß√£o\n\n## üìÖ DISPONIBILIDADE:\n- ‚úÖ Dispon√≠vel / ‚ùå Indispon√≠vel / ‚ö†Ô∏è Parcialmente reservado\n- Agrupe per√≠odos similares quando fizer sentido\n- Seja espec√≠fico com datas\n\n## üéØ AN√ÅLISE T√âCNICA:\n- Confirme o tipo de consulta processada\n- Forne√ßa resumo t√©cnico para facilitar decis√£o\n- Identifique padr√µes importantes (valores fixos, feriados, etc.)\n\n# NUNCA FA√áA:\n- Sugest√µes contradit√≥rias aos dados apresentados\n- Perguntas diretas (\"Que per√≠odo te interessa?\")\n- Ofertas redundantes (\"posso verificar\" quando j√° verificou)\n- Linguagem de vendas ou atendimento direto\n\n# SEMPRE INCLUA:\n- An√°lise completa dos dados encontrados\n- Resumo t√©cnico estruturado\n- Informa√ß√µes-chave para o Marcos processar\n\n\n# EXEMPLOS DE PROCESSAMENTO T√âCNICO:\n\n## Exemplo 1:\nInput: Dados de alta temporada (janeiro 2026, fevereiro 2026 parcial, mar√ßo 2026, dezembro 2025 parcial)\n\nOutput:\nüìä CONSULTA ALTA TEMPORADA 2025-2026 PROCESSADA\n\nüóìÔ∏è PER√çODOS ENCONTRADOS:\n- Janeiro 2026: R$6.000/noite (m√≠n. 5 noites) ‚úÖ\n- Fevereiro 2026 (1-12 e 19-28): R$5.500/noite (m√≠n. 5 noites) ‚úÖ  \n- Mar√ßo 2026: R$4.000/noite (m√≠n. 4 noites) ‚úÖ\n- Dezembro 2025 (1-9 e 16-19): R$3.800/noite (m√≠n. 5 noites) ‚úÖ\n- Dezembro 2025 (10-15): ‚ùå Per√≠odo reservado\n- Carnaval 2026 (13-18 fev): R$7.000/noite (m√≠n. 5 noites) ‚úÖ\n- Natal 2025 (20-26 dez): R$5.000/noite (m√≠n. 5 noites) ‚úÖ\n- R√©veillon 2025 (27-31 dez): R$9.500/noite (m√≠n. 7 noites) ‚úÖ\n\n‚ö†Ô∏è RESUMO T√âCNICO:\n- Total per√≠odos: 7 dispon√≠veis, 1 indispon√≠vel\n- Faixa valores: R$3.800 - R$9.500/noite\n- M√≠nimo noites: 4 a 7 noites (R√©veillon exige 7)\n\n\n## Exemplo 2:\nInput: Dados de outubro (3 per√≠odos encontrados)\n\nOutput:\nüìä CONSULTA OUTUBRO 2025 PROCESSADA\n\nüóìÔ∏è PER√çODOS ENCONTRADOS:\n- 1¬∫ a 11 de outubro: R$3.250/noite (m√≠n. 3 noites) ‚úÖ\n- 12 a 13 de outubro: R$3.250/noite (feriado Aparecida, m√≠n. 3 noites) ‚úÖ\n- 14 a 31 de outubro: R$3.250/noite (m√≠n. 3 noites) ‚úÖ\n\n‚ö†Ô∏è RESUMO T√âCNICO:\n- Total per√≠odos: 3 dispon√≠veis, 0 indispon√≠veis\n- Valor fixo: R$3.250/noite todo o m√™s\n- M√≠nimo noites: 3 noites uniformemente\n\n\n## Exemplo 3:\nInput: Dados do Carnaval 2026\n\nOutput:\nüìä CONSULTA CARNAVAL 2026 PROCESSADA\n\nüóìÔ∏è PER√çODO ENCONTRADO:\n- 13 a 18 de fevereiro: R$7.000/noite (m√≠n. 5 noites) ‚úÖ\n\n‚ö†Ô∏è RESUMO T√âCNICO:\n- Per√≠odo premium espec√≠fico para feriado\n- Valor fixo: R$7.000/noite\n- M√≠nimo obrigat√≥rio: 5 noites\n\n\n## Exemplo 4:\nInput: Consulta espec√≠fica 10-13 outubro (4 noites)\n\nOutput:\nüìä CONSULTA PER√çODO ESPEC√çFICO 10-13 OUTUBRO PROCESSADA\n\nüóìÔ∏è DETALHAMENTO T√âCNICO:\n- 10-11 outubro: R$3.250/noite (per√≠odo geral)\n- 12-13 outubro: R$3.250/noite (feriado Aparecida)\n- Valor total calculado: R$13.000 (4 noites)\n\n‚úÖ AN√ÅLISE T√âCNICA:\n- Status: Totalmente dispon√≠vel\n- Conformidade: Atende m√≠nimo de 3 noites para outubro\n- Observa√ß√£o: Inclui feriado Nossa Senhora Aparecida\n\n\n## Exemplo 5:\nInput: Dados de baixa temporada (julho, agosto, setembro, outubro, novembro)\n\nOutput:\nüìä CONSULTA BAIXA TEMPORADA 2025 PROCESSADA\n\nüóìÔ∏è PER√çODOS ENCONTRADOS:\n- Julho: R$3.000/noite (m√≠n. 3 noites) ‚ö†Ô∏è Parcialmente reservado\n- Agosto: R$3.000/noite (m√≠n. 3 noites) ‚ö†Ô∏è Parcialmente reservado  \n- Setembro: R$3.000/noite (m√≠n. 3 noites) ‚ö†Ô∏è Parcialmente reservado\n- Outubro: R$3.250/noite (m√≠n. 3 noites) ‚úÖ Totalmente dispon√≠vel\n- Novembro: R$3.500/noite (m√≠n. 4 noites) ‚ö†Ô∏è Parcialmente reservado\n\n‚ö†Ô∏è RESUMO T√âCNICO:\n- Faixa valores: R$3.000 - R$3.500/noite\n- M√≠nimo noites: 3-4 noites conforme m√™s\n- Melhor disponibilidade: Outubro (100% livre)\n- Melhor pre√ßo: Julho-setembro (R$3.000/noite)\n\n\n## Exemplo 6:\nInput: Dados de dezembro (mix dispon√≠vel/indispon√≠vel + feriados)\n\nOutput:\nüìä CONSULTA DEZEMBRO 2025 PROCESSADA\n\nüóìÔ∏è PER√çODOS ENCONTRADOS:\n- 1¬∫ a 9 dezembro: R$3.800/noite (alta temp., m√≠n. 5 noites) ‚úÖ\n- 10 a 15 dezembro: ‚ùå Per√≠odo reservado\n- 16 a 19 dezembro: R$3.800/noite (alta temp., m√≠n. 5 noites) ‚úÖ\n- 20 a 26 dezembro: R$5.000/noite (Natal, m√≠n. 5 noites) ‚úÖ\n- 27 a 31 dezembro: R$9.500/noite (R√©veillon, m√≠n. 7 noites) ‚úÖ\n\n‚ö†Ô∏è RESUMO T√âCNICO:\n- Total per√≠odos: 4 dispon√≠veis, 1 indispon√≠vel\n- Faixa valores: R$3.800 - R$9.500/noite\n- Composi√ß√£o: Alta temporada + feriados especiais\n- M√≠nimos variados: 5 noites (geral), 7 noites (R√©veillon)\n\n\n## Exemplo 7:\nInput: Consulta per√≠odo 5-6 setembro (1 noite)\n\nOutput:\nüìä CONSULTA PER√çODO 5-6 SETEMBRO PROCESSADA\n\n‚ùå LIMITA√á√ÉO T√âCNICA IDENTIFICADA:\n- Per√≠odo solicitado: 1 noite (5-6 setembro)\n- M√≠nimo obrigat√≥rio: 3 noites para setembro\n- Status adicional: ‚ùå Per√≠odo 05-08 setembro j√° reservado\n\nüí° ALTERNATIVAS T√âCNICAS DISPON√çVEIS:\n- 01 a 04 setembro: R$3.000/noite (3 noites = R$9.000)\n- 09 a 30 setembro: R$3.000/noite (3+ noites = R$9.000+)\n\n\n## Exemplo 8:\nInput: Consulta geral (todos os dados da tabela)\n\nOutput:\nüìä CONSULTA GERAL VALORES 2025-2026 PROCESSADA\n\nüóìÔ∏è AN√ÅLISE POR CATEGORIA:\nüíé FERIADOS ESPECIAIS: R$3.250 - R$9.500/noite (m√≠n. 3-7 noites)\nüèñÔ∏è ALTA TEMPORADA: R$3.800 - R$6.000/noite (m√≠n. 4-5 noites)  \nüåø BAIXA TEMPORADA: R$3.000 - R$3.500/noite (m√≠n. 3-4 noites)\n\n‚ö†Ô∏è RESUMO T√âCNICO GERAL:\n- Faixa completa: R$3.000 - R$9.500/noite\n- M√≠nimos de estadia: 3-7 noites conforme per√≠odo\n- Valor mais econ√¥mico: Julho-setembro (R$3.000/noite)\n- Valor premium: R√©veillon (R$9.500/noite, m√≠n. 7 noites)\n- Feriado de destaque: Carnaval (R$7.000/noite)\n\n# DIRETRIZES T√âCNICAS BASEADAS NOS EXEMPLOS:\n- Use formato \"PROCESSADA\" no t√≠tulo para confirmar an√°lise completa\n- Sempre inclua \"RESUMO T√âCNICO\" com dados estruturados\n- Para limita√ß√µes, use \"LIMITA√á√ÉO T√âCNICA IDENTIFICADA\"\n- Para alternativas, use \"ALTERNATIVAS T√âCNICAS DISPON√çVEIS\"\n- Mantenha linguagem t√©cnica e informativa, nunca comercial",
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1560,
        -340
      ],
      "id": "a6463e28-9bbc-4aa5-bcb7-4646219bc2a9",
      "name": "AI Agent - Valores Especialista"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "58ec9b54-d62a-4cd2-aacd-3ebbe2573b99",
              "name": "resposta_formatada",
              "value": "={{ $('AI Agent - Valores Especialista').item.json.output }}",
              "type": "string"
            },
            {
              "id": "79425af3-e0e2-4174-ad9f-f7ba50a74c62",
              "name": "consulta_original",
              "value": "={{ $('formatDataForAnalysis').item.json.consulta_original }}",
              "type": "string"
            },
            {
              "id": "354638b1-308a-4c0f-bdf5-8ae94ebdf091",
              "name": "periodos_encontrados",
              "value": "={{ $('formatDataForAnalysis').item.json.periodos_disponiveis }}",
              "type": "number"
            },
            {
              "id": "6458c3d6-e880-4201-aa17-76737484e4d8",
              "name": "timestamp_resposta",
              "value": "={{ $now }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2040,
        -340
      ],
      "id": "35da4983-32d5-4ef7-bac6-dc295ecbc749",
      "name": "prepareResponse"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "58ec9b54-d62a-4cd2-aacd-3ebbe2573b99",
              "name": "resposta_formatada",
              "value": "N√£o encontrei disponibilidade para o per√≠odo consultado. \n\nPoderia me dizer uma data espec√≠fica ou per√≠odo alternativo para verificar nossa disponibilidade? üóìÔ∏è",
              "type": "string"
            },
            {
              "id": "79425af3-e0e2-4174-ad9f-f7ba50a74c62",
              "name": "consulta_original",
              "value": "={{ $('buildSupabaseQuery').item.json.consulta_original }}",
              "type": "string"
            },
            {
              "id": "354638b1-308a-4c0f-bdf5-8ae94ebdf091",
              "name": "periodos_encontrados",
              "value": 0,
              "type": "number"
            },
            {
              "id": "6458c3d6-e880-4201-aa17-76737484e4d8",
              "name": "timestamp_resposta",
              "value": "={{ $now }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1400,
        80
      ],
      "id": "f0aedfd6-ea3c-40bd-bc43-18c14e6bdfdb",
      "name": "noResultsResponse"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "consulta_cliente"
            },
            {
              "name": "phone_canon"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -540,
        -180
      ],
      "id": "66a9471a-fe7e-42c7-89b0-d6fcad4f34bc",
      "name": "ExecuteWorkflowTrigger"
    },
    {
      "parameters": {
        "jsCode": "// const queryData = $('parseQueryFilters').item.json;\n// const filters = queryData.supabase_filters;\n\n// // Construir query string para Supabase REST API\n// let queryParams = [];\n\n// filters.forEach(filter => {\n//   // L√ìGICA ESPECIAL: Para consultas de temporada, incluir feriados tamb√©m\n//   if (filter.keyName === 'tipo_periodo') {\n//     if (filter.keyValue === 'alta_temporada') {\n//       queryParams.push(`tipo_periodo=in.(alta_temporada,feriado)`);\n//       return;\n//     } else if (filter.keyValue === 'baixa_temporada') {\n//       queryParams.push(`tipo_periodo=in.(baixa_temporada,feriado)`);\n//       return;\n//     }\n//   }\n  \n//   // Se √© consulta de temporada e ano=2025, buscar tamb√©m 2026\n//   if (filter.keyName === 'ano' && filter.keyValue === '2025' && \n//       (queryData.tipo_consulta === 'alta_temporada' || queryData.tipo_consulta === 'baixa_temporada')) {\n//     queryParams.push(`ano=in.(2025,2026)`);\n//     return;\n//   }\n  \n//   switch(filter.condition) {\n//     case 'eq':\n//       queryParams.push(`${filter.keyName}=eq.${filter.keyValue}`);\n//       break;\n//     case 'lte':\n//       queryParams.push(`${filter.keyName}=lte.${filter.keyValue}`);\n//       break;\n//     case 'gte':\n//       queryParams.push(`${filter.keyName}=gte.${filter.keyValue}`);\n//       break;\n//     case 'ilike':\n//       queryParams.push(`${filter.keyName}=ilike.${filter.keyValue}`);\n//       break;\n//   }\n// });\n\n// const queryString = queryParams.join('&');\n// const baseUrl = 'https://ywlvhsujqfqrpsoryryz.supabase.co';\n// const fullUrl = `${baseUrl}/rest/v1/b_periodos_casa_canal?${queryString}&order=prioridade.asc,data_inicio.asc`;\n\n// console.log('Query URL constru√≠da:', fullUrl);\n// console.log('Filtros aplicados:', filters);\n\n// return [{ \n//   json: { \n//     query_url: fullUrl, \n//     original_filters: filters,\n//     consulta_original: queryData.consulta_original \n//   } \n// }];\n\n// TESTE SIMPLES - substitua temporariamente o buildSupabaseQuery\n\n// VERS√ÉO CORRIGIDA do buildSupabaseQuery\n\nconst queryData = $('parseQueryFilters').item.json;\nconst filters = queryData.supabase_filters;\n\nconst baseUrl = 'https://ywlvhsujqfqrpsoryryz.supabase.co';\n\nconsole.log('=== DEBUG QUERY BUILDER ===');\nconsole.log('QueryData:', queryData);\nconsole.log('Filters:', filters);\n\n// Verificar se filters existe\nif (!filters || !Array.isArray(filters) || filters.length === 0) {\n  console.log('‚ö†Ô∏è Sem filtros, fazendo query geral');\n  const fallbackUrl = `${baseUrl}/rest/v1/b_periodos_casa_canal?select=*&order=prioridade.asc,data_inicio.asc&limit=20`;\n  return [{ \n    json: { \n      query_url: fallbackUrl,\n      consulta_original: queryData.consulta_original || 'Consulta geral'\n    } \n  }];\n}\n\n// Construir par√¢metros de forma mais segura\nlet queryParams = [];\n\nfilters.forEach((filter, index) => {\n  try {\n    console.log(`Processando filter ${index}:`, filter);\n    \n    // Validar estrutura do filtro\n    if (!filter.keyName || !filter.condition || filter.keyValue === undefined) {\n      console.log(`‚ö†Ô∏è Filter ${index} inv√°lido, pulando`);\n      return;\n    }\n    \n    const keyName = filter.keyName.trim();\n    const condition = filter.condition.trim();\n    let keyValue = filter.keyValue;\n    \n    // Tratar valores especiais\n    if (typeof keyValue === 'string') {\n      keyValue = keyValue.trim();\n    }\n    \n    // L√≥gica especial para temporadas\n    if (keyName === 'tipo_periodo') {\n      if (keyValue === 'alta_temporada') {\n        queryParams.push(`tipo_periodo=in.(alta_temporada,feriado)`);\n        return;\n      } else if (keyValue === 'baixa_temporada') {\n        queryParams.push(`tipo_periodo=in.(baixa_temporada,feriado)`);\n        return;\n      }\n    }\n    \n    // L√≥gica para anos m√∫ltiplos\n    if (keyName === 'ano' && keyValue === '2025' && \n        (queryData.tipo_consulta === 'alta_temporada' || queryData.tipo_consulta === 'baixa_temporada')) {\n      queryParams.push(`ano=in.(2025,2026)`);\n      return;\n    }\n    \n    // Construir par√¢metro normal\n    switch(condition) {\n      case 'eq':\n        queryParams.push(`${keyName}=eq.${encodeURIComponent(keyValue)}`);\n        break;\n      case 'lte':\n        queryParams.push(`${keyName}=lte.${encodeURIComponent(keyValue)}`);\n        break;\n      case 'gte':\n        queryParams.push(`${keyName}=gte.${encodeURIComponent(keyValue)}`);\n        break;\n      case 'ilike':\n        queryParams.push(`${keyName}=ilike.${encodeURIComponent(keyValue)}`);\n        break;\n      default:\n        console.log(`‚ö†Ô∏è Condi√ß√£o desconhecida: ${condition}`);\n    }\n    \n  } catch (error) {\n    console.log(`‚ùå Erro no filter ${index}:`, error.message);\n  }\n});\n\n// Montar URL final\nconst select = 'select=*';\nconst order = 'order=prioridade.asc,data_inicio.asc';\nconst limit = 'limit=50';\n\nlet finalParams = [select, order, limit];\nif (queryParams.length > 0) {\n  finalParams = [select, ...queryParams, order, limit];\n}\n\nconst queryString = finalParams.join('&');\nconst fullUrl = `${baseUrl}/rest/v1/b_periodos_casa_canal?${queryString}`;\n\nconsole.log('=== RESULTADO ===');\nconsole.log('Query params:', queryParams);\nconsole.log('Final URL:', fullUrl);\nconsole.log('URL length:', fullUrl.length);\n\n// Verificar tamanho da URL\nif (fullUrl.length > 2000) {\n  console.log('‚ùå URL muito longa, usando query simplificada');\n  const simpleUrl = `${baseUrl}/rest/v1/b_periodos_casa_canal?select=*&ano=eq.2025&order=prioridade.asc&limit=20`;\n  return [{ \n    json: { \n      query_url: simpleUrl,\n      consulta_original: queryData.consulta_original,\n      fallback: true\n    } \n  }];\n}\n\nreturn [{ \n  json: { \n    query_url: fullUrl, \n    original_filters: filters,\n    consulta_original: queryData.consulta_original,\n    debug: {\n      queryParams: queryParams,\n      success: true\n    }\n  } \n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        -180
      ],
      "id": "ff763500-1775-4845-b4ad-31437f60c153",
      "name": "buildSupabaseQuery"
    },
    {
      "parameters": {
        "url": "={{ $json.query_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3bHZoc3VqcWZxcnBzb3J5cnl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MzU4NjUsImV4cCI6MjA2MTAxMTg2NX0.JE8Ku8PsH1xNAoYBGS1Hm5oCD3bwCQFa9eOEUMsPZUw"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3bHZoc3VqcWZxcnBzb3J5cnl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0MzU4NjUsImV4cCI6MjA2MTAxMTg2NX0.JE8Ku8PsH1xNAoYBGS1Hm5oCD3bwCQFa9eOEUMsPZUw"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        860,
        -180
      ],
      "id": "79b3398a-37c7-42ba-85bc-b42abe3c22b3",
      "name": "getPeriodosRelevantes"
    }
  ],
  "pinData": {
    "ExecuteWorkflowTrigger": [
      {
        "json": {
          "consulta_cliente": "Lead perguntou sobre natal",
          "phone_canon": null
        }
      }
    ]
  },
  "connections": {
    "setConsultaData": {
      "main": [
        [
          {
            "node": "AI Agent - Query Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model - Query Generator": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Query Generator",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Query Generator": {
      "main": [
        [
          {
            "node": "parseQueryFilters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "parseQueryFilters": {
      "main": [
        [
          {
            "node": "buildSupabaseQuery",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "verificaResultados": {
      "main": [
        [
          {
            "node": "formatDataForAnalysis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "noResultsResponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formatDataForAnalysis": {
      "main": [
        [
          {
            "node": "AI Agent - Valores Especialista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model - Formatador": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Valores Especialista",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Valores Especialista": {
      "main": [
        [
          {
            "node": "prepareResponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ExecuteWorkflowTrigger": {
      "main": [
        [
          {
            "node": "setConsultaData",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "buildSupabaseQuery": {
      "main": [
        [
          {
            "node": "getPeriodosRelevantes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "getPeriodosRelevantes": {
      "main": [
        [
          {
            "node": "verificaResultados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ae1ae132-7e3a-4a29-9d09-034c937c6048",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "35a1a031c5e8e1ff0c9e8fa545d3b65aa09dcbc4ad66d061f8f33d9e2e8f3a1b"
  },
  "id": "0BjEJ8sM7ZgE7301",
  "tags": []
}